name: Compilar Cheat Engine (Versi贸n Completa) para Windows

on:
  workflow_dispatch: # Permite la ejecuci贸n manual

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Clonar el repositorio de Cheat Engine
      uses: actions/checkout@v4
      with:
        repository: cheat-engine/cheat-engine
        submodules: 'recursive'

    - name: Configurar MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v1.3

    # ==================== BLOQUE CORREGIDO ====================
    - name: Instalar Lazarus IDE y Cross-Compiler
      shell: powershell
      run: |
        echo "Descargando Lazarus IDE (64-bit) usando curl..."
        $lazarus_url = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-win64.exe/download"
        curl.exe -L -o lazarus_installer.exe $lazarus_url
        
        echo "Descargando Lazarus Cross-Compiler (i386-win32) usando curl..."
        $cross_compiler_url = "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-cross-i386-win32-win64.exe/download"
        curl.exe -L -o lazarus_cross_compiler_installer.exe $cross_compiler_url

        echo "Instalando Lazarus IDE silenciosamente..."
        Start-Process -FilePath ".\lazarus_installer.exe" -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait
        
        echo "Instalando Lazarus Cross-Compiler silenciosamente..."
        Start-Process -FilePath ".\lazarus_cross_compiler_installer.exe" -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait

        echo "Agregando Lazarus al PATH..."
        echo "C:\lazarus" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    # ========================================================

    - name: Compilar proyectos de Lazarus (.lpi, .lpr)
      shell: cmd
      run: |
        echo "Compilando Cheat Engine (64-bit y 32-bit)..."
        lazbuild "Cheat Engine\cheatengine.lpi"
        lazbuild "Cheat Engine\cheatengine.lpi" --cpu=i386 --os=win32

        echo "Compilando speedhack (64-bit y 32-bit)..."
        lazbuild "Cheat Engine\speedhack\speedhack.lpr"
        lazbuild "Cheat Engine\speedhack\speedhack.lpr" --cpu=i386 --os=win32

        echo "Compilando luaclient (64-bit y 32-bit)..."
        lazbuild "Cheat Engine\luaclient\luaclient.lpr"
        lazbuild "Cheat Engine\luaclient\luaclient.lpr" --cpu=i386 --os=win32

        echo "Compilando vehdebug (64-bit y 32-bit)..."
        lazbuild "Cheat Engine\vehdebug\vehdebug.lpr"
        lazbuild "Cheat Engine\vehdebug\vehdebug.lpr" --cpu=i386 --os=win32

    - name: Compilar proyectos de Visual Studio (.sln)
      shell: cmd
      run: |
        echo "Compilando proyectos de MSBuild..."
        rem DirectX Mess (32 y 64 bits)
        msbuild "Cheat Engine\DirectXMess\DirectXMess.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine\DirectXMess\DirectXMess.sln" /p:Configuration=Release /p:Platform=Win32

        rem DotNet Data Collector (32 y 64 bits)
        msbuild "Cheat Engine\DotNetDataCollector\dotnetdatacollector.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine\DotNetDataCollector\dotnetdatacollector.sln" /p:Configuration=Release /p:Platform=x86

        rem Mono Data Collector (32 y 64 bits)
        msbuild "Cheat Engine\MonoDataCollector\MonoDataCollector.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine\MonoDataCollector\MonoDataCollector.sln" /p:Configuration=Release /p:Platform=x86

        rem Java Support (32 y 64 bits)
        msbuild "Cheat Engine\cejavahook\cejvmti.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine\cejavahook\cejvmti.sln" /p:Configuration=Release /p:Platform=Win32

        rem Kernel Driver (DBKKernel) - Versi贸n sin firma
        msbuild "Cheat Engine\dbk\DBKKernel.sln" /p:Configuration="Release No-Sig" /p:Platform=x64
        
        rem Tiny C Compiler (TCC)
        msbuild "Cheat Engine\tcclib\tcclib.sln" /p:Configuration=Release /p:Platform=x64
        msbuild "Cheat Engine\tcclib\tcclib.sln" /p:Configuration=Release /p:Platform=Win32

    - name: Preparar y subir artefacto de compilaci贸n
      uses: actions/upload-artifact@v4
      with:
        name: CheatEngine-Windows-Completo
        path: |
          Cheat Engine/bin/
          Cheat Engine/bin64/
          Cheat Engine/luaclient/*.dll
          Cheat Engine/speedhack/*.dll
          Cheat Engine/vehdebug/*.dll
          Cheat Engine/DirectXMess/x64/Release/d3dhook.dll
          Cheat Engine/DirectXMess/Release/d3dhook.dll
          Cheat Engine/DotNetDataCollector/bin/x64/Release/*.dll
          Cheat Engine/DotNetDataCollector/bin/x86/Release/*.dll
          Cheat Engine/MonoDataCollector/bin/x64/Release/*.dll
          Cheat Engine/MonoDataCollector/bin/x86/Release/*.dll
          Cheat Engine/cejavahook/x64/Release/*.dll
          Cheat Engine/cejavahook/Release/*.dll
          Cheat Engine/dbk/x64/Release No-Sig/dbk64.sys
          Cheat Engine/tcclib/x64/Release/tcclib.dll
          Cheat Engine/tcclib/Win32/Release/tcclib.dll

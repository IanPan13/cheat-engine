name: Compilar Cheat Engine (Versión Completa) para Windows

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Clonar el repositorio de Cheat Engine
      uses: actions/checkout@v4
      with:
        repository: cheat-engine/cheat-engine
        submodules: 'recursive'

    - name: Configurar MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v1.3

    - name: Instalar Lazarus IDE y Cross-Compiler
      shell: powershell
      run: |
        curl.exe -L -o lazarus_installer.exe "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-win64.exe/download"
        curl.exe -L -o lazarus_cross_compiler_installer.exe "https://sourceforge.net/projects/lazarus/files/Lazarus%20Windows%2064%20bits/Lazarus%202.2.2/lazarus-2.2.2-fpc-3.2.2-cross-i386-win32-win64.exe/download"
        Start-Process -FilePath ".\lazarus_installer.exe" -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait
        Start-Process -FilePath ".\lazarus_cross_compiler_installer.exe" -ArgumentList "/VERYSILENT /NORESTART /DIR=C:\lazarus" -Wait
        echo "C:\lazarus" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Compilar proyectos de Lazarus
      shell: cmd
      working-directory: 'Cheat Engine'
      run: |
        lazbuild cheatengine.lpi
        lazbuild cheatengine.lpi --cpu=i386 --os=win32
        lazbuild speedhack/speedhack.lpr
        lazbuild speedhack/speedhack.lpr --cpu=i386 --os=win32
        lazbuild luaclient/luaclient.lpr
        lazbuild luaclient/luaclient.lpr --cpu=i386 --os=win32
        lazbuild vehdebug/vehdebug.lpr
        lazbuild vehdebug/vehdebug.lpr --cpu=i386 --os=win32

    - name: Compilar proyectos de Visual Studio
      shell: powershell
      run: |
        # Cambiamos al directorio correcto
        Set-Location -Path (Join-Path $env:GITHUB_WORKSPACE "Cheat Engine")
        Write-Host "Directorio de trabajo actual: $((Get-Location).Path)"

        # Argumentos comunes
        $common_args = "/p:WindowsTargetPlatformVersion=10.0", "/p:PlatformToolset=v143"

        # Función de ayuda para compilar y verificar
        function Build-Solution {
            param($sln_path, $platform, $extra_args)
            Write-Host "----------------------------------------------------"
            Write-Host "Compilando: $sln_path para Plataforma: $platform"
            $exists = Test-Path $sln_path
            Write-Host "Verificando si el archivo existe: $exists"
            if (-not $exists) {
                throw "¡ERROR! El archivo de solución '$sln_path' no se encontró."
            }
            # Usamos /t:build para ser explícitos
            msbuild.exe $sln_path /t:build /p:Configuration=Release "/p:Platform=$platform" $common_args $extra_args
        }

        # Compilar cada componente
        Build-Solution -sln_path "DirectXMess\DirectXMess.sln" -platform "x64"
        Build-Solution -sln_path "DirectXMess\DirectXMess.sln" -platform "Win32"
        
        Build-Solution -sln_path "DotNetDataCollector\dotnetdatacollector.sln" -platform "x64"
        Build-Solution -sln_path "DotNetDataCollector\dotnetdatacollector.sln" -platform "Win32"
        
        Build-Solution -sln_path "MonoDataCollector\MonoDataCollector.sln" -platform "x64"
        Build-Solution -sln_path "MonoDataCollector\MonoDataCollector.sln" -platform "Win32"
        
        Build-Solution -sln_path "cejavahook\cejvmti.sln" -platform "x64"
        Build-Solution -sln_path "cejavahook\cejvmti.sln" -platform "Win32"
        
        Build-Solution -sln_path "dbk\DBKKernel.sln" -platform "x64" -extra_args "/p:Configuration=Release No-Sig"
        
        Build-Solution -sln_path "tcclib\tcclib.sln" -platform "x64"
        Build-Solution -sln_path "tcclib\tcclib.sln" -platform "Win32"
        
        Write-Host "----------------------------------------------------"
        Write-Host "Compilación de proyectos de Visual Studio finalizada."

    - name: Preparar y subir artefacto de compilación
      uses: actions/upload-artifact@v4
      with:
        name: CheatEngine-Windows-Completo
        path: |
          Cheat Engine/bin/
          Cheat Engine/bin64/

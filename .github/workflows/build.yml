name: Compilar Cheat Engine 7.5 (Versión Completa y Estable)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: 1. Clonar Cheat Engine 7.5 y submódulos
      uses: actions/checkout@v4
      with:
        repository: cheat-engine/cheat-engine
        ref: '7.5'        # Usamos la etiqueta de una versión estable
        submodules: true  # 'true' es suficiente y claro para inicializar submódulos

    - name: 2. Configurar Lazarus IDE 2.2.2
      uses: gcarreno/setup-lazarus@v3.2.15
      with:
        lazarus-version: "2.2.2"

    - name: 3. Configurar MSBuild (Visual Studio)
      uses: microsoft/setup-msbuild@v1.3

    - name: 4. Compilar proyectos de Lazarus (32 y 64 bits)
      shell: cmd
      working-directory: 'Cheat Engine'
      run: |
        echo "Compilando componentes de Lazarus..."
        lazbuild cheatengine.lpi
        lazbuild cheatengine.lpi --cpu=i386 --os=win32
        lazbuild speedhack/speedhack.lpr
        lazbuild speedhack/speedhack.lpr --cpu=i386 --os=win32
        lazbuild luaclient/luaclient.lpr
        lazbuild luaclient/luaclient.lpr --cpu=i386 --os=win32
        lazbuild vehdebug/vehdebug.lpr
        lazbuild vehdebug/vehdebug.lpr --cpu=i386 --os=win32

    - name: 5. Compilar proyectos de Visual Studio (32 y 64 bits)
      shell: powershell
      working-directory: '.\Cheat Engine'
      run: |
        echo "Compilando componentes de Visual Studio..."
        $common_args = "/p:Configuration=Release", "/p:WindowsTargetPlatformVersion=10.0", "/p:PlatformToolset=v143"
        
        msbuild.exe "DirectXMess\DirectXMess.sln" $common_args "/p:Platform=x64"
        msbuild.exe "DirectXMess\DirectXMess.sln" $common_args "/p:Platform=Win32"
        
        msbuild.exe "DotNetDataCollector\dotnetdatacollector.sln" $common_args "/p:Platform=x64"
        msbuild.exe "DotNetDataCollector\dotnetdatacollector.sln" $common_args "/p:Platform=Win32"
        
        msbuild.exe "MonoDataCollector\MonoDataCollector.sln" $common_args "/p:Platform=x64"
        msbuild.exe "MonoDataCollector\MonoDataCollector.sln" $common_args "/p:Platform=Win32"
        
        msbuild.exe "cejavahook\cejvmti.sln" $common_args "/p:Platform=x64"
        msbuild.exe "cejavahook\cejvmti.sln" $common_args "/p:Platform=Win32"
        
        msbuild.exe "dbk\DBKKernel.sln" $common_args "/p:Platform=x64" "/p:Configuration=Release No-Sig"
        
        msbuild.exe "tcclib\tcclib.sln" $common_args "/p:Platform=x64"
        msbuild.exe "tcclib\tcclib.sln" $common_args "/p:Platform=Win32"

    - name: 6. Empaquetar y subir artefacto de compilación
      uses: actions/upload-artifact@v4
      with:
        name: CheatEngine-7.5-Windows-Completo
        path: |
          Cheat Engine/bin/
          Cheat Engine/bin64/
